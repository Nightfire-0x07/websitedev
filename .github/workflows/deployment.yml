name: GitHub Pages Deployment

on:
  push:
    branches: [main]

jobs:
  project-setup:
    runs-on: ubuntu-latest
    steps:
    - uses: ./github/workflows/setup-project
      with:
        main-branch: true
        production: true
  build:
    runs-on: ubuntu-latest
    needs: project-setup
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Retrieve pre-setup project
        uses: actions/download-artifact@v1
        with:
          name: ${{ needs.project-setup.outputs.BUILD_NAME }}
      - name: Build
        run: npm run build
      # This allows us to utilise the build in the deployment job.
      - name: Upload Build
        uses: actions/upload-artifact@v3
        with:
          name: website-gh-actions-build
          path: dist
          retention-days: 1
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout # Checkout simply to fix issues with GH deploy
        uses: actions/checkout@v3
        with:
          ref: main
      - name: Retrieve Build
        uses: actions/download-artifact@v1
        with:
          name: website-gh-actions-build
      - name: Deploy on GH Pages
        uses: JamesIves/github-pages-deploy-action@v4.3.3
        with:
          branch: gh-pages
          folder: website-gh-actions-build
